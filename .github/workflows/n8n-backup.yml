# N8N工作流自动备份（过滤敏感信息+保留原名称+完整数据）
name: N8N工作流自动备份

on:
  schedule:
    - cron: '0 2 * * *'  # 北京时间10点自动备份
  workflow_dispatch:     # 手动触发

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装依赖工具
        run: |
          sudo apt update && sudo apt install -y jq curl
          mkdir -p ./backups/$(date +%Y-%m-%d_%H-%M-%S)

      - name: 导出n8n工作流（过滤敏感信息）
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_URL: "https://n8n.lbuding.com"  # 你的n8n地址
        run: |
          # ========== 1. 请求工作流列表 ==========
          WORKFLOW_LIST_RESPONSE=$(curl -s -X GET "$N8N_URL/api/v1/workflows" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json")

          # ========== 2. 创建备份目录 ==========
          BACKUP_DIR=./backups/$(date +%Y-%m-%d_%H-%M-%S)
          mkdir -p $BACKUP_DIR

          # ========== 3. 解析工作流ID并备份 ==========
          WORKFLOW_IDS=$(echo "$WORKFLOW_LIST_RESPONSE" | jq -r '.data[].id')

          for ID in $WORKFLOW_IDS; do
            if [ "$ID" = "null" ] || [ -z "$ID" ]; then
              continue
            fi

            # 获取原名称并处理非法字符
            WORKFLOW_NAME=$(echo "$WORKFLOW_LIST_RESPONSE" | jq -r --arg ID "$ID" '.data[] | select(.id == $ID) | .name')
            WORKFLOW_NAME=$(echo "$WORKFLOW_NAME" | sed -e 's/[\/\\:*?"<>|]/_/g' -e 's/^[. ]//g')
            if [ "$WORKFLOW_NAME" = "null" ] || [ -z "$WORKFLOW_NAME" ]; then
              WORKFLOW_NAME="未命名工作流_$ID"
            fi

            # 获取工作流完整数据
            WORKFLOW_DETAIL=$(curl -s -X GET "$N8N_URL/api/v1/workflows/$ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json")

            # ========== 核心：过滤敏感信息（替换各类密钥为占位符） ==========
            # 1. 替换Apify API Token（匹配apify_api_开头的字符串）
            WORKFLOW_DETAIL=$(echo "$WORKFLOW_DETAIL" | sed -E 's/apify_api_[a-zA-Z0-9]+/apify_api_***REDACTED***/g')
            # 2. 替换通用API Key/Token（匹配api_key_/token_/api_token_开头的字符串）
            WORKFLOW_DETAIL=$(echo "$WORKFLOW_DETAIL" | sed -E 's/(api_key|token|api_token)_[a-zA-Z0-9]+/\1_***REDACTED***/g')
            # 3. 替换数字+字母组合的长密钥（如64位字符的密钥，可根据需要调整）
            WORKFLOW_DETAIL=$(echo "$WORKFLOW_DETAIL" | sed -E 's/[a-zA-Z0-9]{32,64}/***REDACTED_KEY***/g')
            # 4. 替换URL中的token参数（如?token=xxx）
            WORKFLOW_DETAIL=$(echo "$WORKFLOW_DETAIL" | sed -E 's/(\?|&)token=[a-zA-Z0-9]+/\1token=***REDACTED***/g')

            # 保存过滤后的文件
            echo "$WORKFLOW_DETAIL" > "$BACKUP_DIR/$WORKFLOW_NAME-$ID.json"
            echo "===== 已备份并过滤敏感信息：$WORKFLOW_NAME-$ID.json ====="
          done

      - name: 提交并推送备份
        env:
          SINGLE_SECRET: ${{ secrets.N8N_API_KEY }}
          GITHUB_REPO_URL: "https://github.com/lengbuding1991/n8n-backups.git"  # 你的仓库地址
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # 适配PAT推送
          if echo "$SINGLE_SECRET" | grep -q "|||"; then
            GITHUB_PAT=$(echo "$SINGLE_SECRET" | cut -d'|||' -f2)
            PUSH_URL=$(echo "$GITHUB_REPO_URL" | sed "s/https:\/\//https:\/\/$GITHUB_PAT@/")
          else
            PUSH_URL="$GITHUB_REPO_URL"
          fi

          # 推送文件
          if [ -n "$(ls -A ./backups 2>/dev/null)" ]; then
            git add ./backups
            git commit -m "n8n工作流备份_$(date +%Y-%m-%d_%H-%M-%S)（已过滤敏感信息）"
            git push "$PUSH_URL" main
          else
            echo "无备份文件，跳过推送"
          fi
