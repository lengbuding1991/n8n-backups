name: N8N工作流自动备份

on:
  schedule:
    - cron: '0 2 * * *'  # 北京时间10点（UTC+8）
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装依赖工具
        run: |
          sudo apt update && sudo apt install -y jq curl
          mkdir -p ./backups/$(date +%Y-%m-%d_%H-%M-%S)

      - name: 导出n8n工作流（保留原名称）
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_URL: "https://n8n.lbuding.com"
        run: |
          # 1. 请求工作流列表
          RESPONSE=$(curl -s -X GET "$N8N_URL/api/v1/workflows" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json")
          
          # 2. 解析工作流ID（data字段下）
          WORKFLOW_IDS=$(echo "$RESPONSE" | jq -r '.data[].id')
          
          # 3. 逐个导出
          BACKUP_DIR=./backups/$(date +%Y-%m-%d_%H-%M-%S)
          mkdir -p $BACKUP_DIR
          
          for ID in $WORKFLOW_IDS; do
            if [ "$ID" = "null" ] || [ -z "$ID" ]; then
              continue
            fi

            # 【核心优化1：从工作流列表中直接获取名称（无需二次请求）】
            # 从最初的RESPONSE中提取名称（避免二次请求单个工作流，效率更高）
            WORKFLOW_NAME=$(echo "$RESPONSE" | jq -r --arg ID "$ID" '.data[] | select(.id == $ID) | .name')

            # 【核心优化2：只替换文件名非法字符，保留原名称】
            # 非法字符：/ \ : * ? " < > | （替换为下划线，其他字符保留）
            WORKFLOW_NAME=$(echo "$WORKFLOW_NAME" | sed -e 's/[\/\\:*?"<>|]/_/g' -e 's/^[. ]//g')

            # 兜底：若名称为空，用ID代替（防止极端情况）
            if [ "$WORKFLOW_NAME" = "null" ] || [ -z "$WORKFLOW_NAME" ]; then
              WORKFLOW_NAME="unnamed_workflow_$ID"
            fi

            # 导出工作流文件
            curl -s -X GET "$N8N_URL/api/v1/workflows/$ID/export" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -o "$BACKUP_DIR/$WORKFLOW_NAME-$ID.json"
          done

      - name: 提交并推送备份
        env:
          SINGLE_SECRET: ${{ secrets.N8N_API_KEY }}
        run: |
          # 拆分Secret（若你用了拼接的PAT，保留这部分；若用方案1权限，可删除拆分逻辑，直接用内置TOKEN）
          if echo "$SINGLE_SECRET" | grep -q "|||"; then
            GITHUB_PAT=$(echo $SINGLE_SECRET | cut -d'|||' -f2)
            REMOTE_URL="https://$GITHUB_PAT@github.com/lengbuding1991/n8n-backups.git"
          else
            REMOTE_URL="origin"
          fi

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          if [ -n "$(ls -A ./backups 2>/dev/null)" ]; then
            git add ./backups
            git commit -m "n8n工作流备份 $(date +%Y-%m-%d_%H-%M-%S)"
            # 推送（适配两种方式）
            git push $REMOTE_URL main
          else
            echo "没有备份文件，跳过提交"
          fi
