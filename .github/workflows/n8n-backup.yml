# N8N工作流自动备份（批量导出版，带全量调试日志）
name: N8N工作流自动备份

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装依赖工具
        run: |
          sudo apt update && sudo apt install -y jq curl
          # 调试：输出已安装的工具版本
          echo "===== 工具版本 ====="
          jq --version
          curl --version
          mkdir -p ./backups/$(date +%Y-%m-%d_%H-%M-%S)

      - name: 批量导出n8n工作流（带调试日志）
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_URL: "https://n8n.lbuding.com" # 【需确认：你的n8n地址，不要加末尾/】
        run: |
          # ========== 调试：输出环境变量（隐藏敏感信息） ==========
          echo "===== 环境变量检查 ====="
          echo "N8N_URL: $N8N_URL"
          echo "N8N_API_KEY: ${N8N_API_KEY:0:5}***" # 只显示前5位，保护密钥

          # ========== 1. 请求n8n工作流列表（带错误输出） ==========
          echo "===== 开始请求n8n工作流列表 ====="
          # 先测试API连通性（输出curl的详细日志）
          WORKFLOW_LIST_RESPONSE=$(curl -v -s -X GET "$N8N_URL/api/v1/workflows" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json" 2>&1) # 捕获curl的详细错误

          # 调试：输出完整的API返回内容
          echo "===== n8n工作流列表API返回内容 ====="
          echo "$WORKFLOW_LIST_RESPONSE"
          echo "===== API返回内容结束 ====="

          # 若/api/v1/workflows失败，自动尝试/api/workflows（旧版本路径）
          if echo "$WORKFLOW_LIST_RESPONSE" | grep -q "404\|error\|not found"; then
            echo "===== /api/v1/workflows路径失败，尝试/api/workflows ====="
            WORKFLOW_LIST_RESPONSE=$(curl -s -X GET "$N8N_URL/api/workflows" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json")
            echo "===== /api/workflows返回内容 ====="
            echo "$WORKFLOW_LIST_RESPONSE"
          fi

          # ========== 2. 创建备份目录 ==========
          BACKUP_ROOT_DIR=./backups
          BACKUP_DIR=$BACKUP_ROOT_DIR/$(date +%Y-%m-%d_%H-%M-%S)
          mkdir -p $BACKUP_DIR
          echo "===== 备份目录已创建：$BACKUP_DIR ====="

          # ========== 3. 批量导出所有工作流 ==========
          echo "===== 开始批量导出n8n工作流 ====="
          # 先尝试带v1的批量路径
          BATCH_BACKUP_CONTENT=$(curl -s -X GET "$N8N_URL/api/v1/workflows/export/all" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json")

          # 若失败，尝试去掉v1的批量路径
          if echo "$BATCH_BACKUP_CONTENT" | grep -q "404\|error\|Version not found"; then
            echo "===== /api/v1/workflows/export/all失败，尝试/api/workflows/export/all ====="
            BATCH_BACKUP_CONTENT=$(curl -s -X GET "$N8N_URL/api/workflows/export/all" \
              -H "X-N8N-API-KEY: $N8N_API_KEY")
          fi

          # 调试：输出批量导出内容
          echo "===== 批量导出内容 ====="
          echo "$BATCH_BACKUP_CONTENT"
          # 保存批量总文件
          echo "$BATCH_BACKUP_CONTENT" > "$BACKUP_DIR/n8n_所有工作流_批量备份.json"
          echo "===== 批量总文件已保存 ====="

          # ========== 4. 拆分单个文件 ==========
          echo "===== 开始拆分单个工作流文件 ====="
          # 解析工作流ID（适配data字段和直接数组）
          WORKFLOW_IDS=$(echo "$WORKFLOW_LIST_RESPONSE" | jq -r '.data[].id' 2>/dev/null || echo "$WORKFLOW_LIST_RESPONSE" | jq -r '.[].id' 2>/dev/null)
          echo "===== 解析出的工作流ID：$WORKFLOW_IDS ====="

          for ID in $WORKFLOW_IDS; do
            if [ "$ID" = "null" ] || [ -z "$ID" ]; then
              continue
            fi

            # 获取原名称（适配两种结构）
            WORKFLOW_NAME=$(echo "$WORKFLOW_LIST_RESPONSE" | jq -r --arg ID "$ID" '.data[] | select(.id == $ID) | .name' 2>/dev/null || echo "$WORKFLOW_LIST_RESPONSE" | jq -r --arg ID "$ID" '.[] | select(.id == $ID) | .name' 2>/dev/null)
            # 替换非法字符
            WORKFLOW_NAME=$(echo "$WORKFLOW_NAME" | sed -e 's/[\/\\:*?"<>|]/_/g' -e 's/^[. ]//g')
            if [ "$WORKFLOW_NAME" = "null" ] || [ -z "$WORKFLOW_NAME" ]; then
              WORKFLOW_NAME="未命名工作流_$ID"
            fi

            # 拆分单个文件（适配两种结构）
            echo "$BATCH_BACKUP_CONTENT" | jq -r --arg ID "$ID" '.[] | select(.id == $ID)' > "$BACKUP_DIR/$WORKFLOW_NAME-$ID.json" 2>/dev/null || echo "$BATCH_BACKUP_CONTENT" | jq -r --arg ID "$ID" '.data[] | select(.id == $ID)' > "$BACKUP_DIR/$WORKFLOW_NAME-$ID.json" 2>/dev/null
            echo "===== 已保存：$WORKFLOW_NAME-$ID.json ====="
          done

      - name: 提交并推送备份
        env:
          SINGLE_SECRET: ${{ secrets.N8N_API_KEY }}
          GITHUB_REPO_URL: "https://github.com/lengbuding1991/n8n-backups.git" # 【需替换为你的仓库】
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # 适配PAT推送
          if echo "$SINGLE_SECRET" | grep -q "|||"; then
            GITHUB_PAT=$(echo "$SINGLE_SECRET" | cut -d'|||' -f2)
            PUSH_URL=$(echo "$GITHUB_REPO_URL" | sed "s/https:\/\//https:\/\/$GITHUB_PAT@/")
          else
            PUSH_URL="$GITHUB_REPO_URL"
          fi

          if [ -n "$(ls -A ./backups 2>/dev/null)" ]; then
            git add ./backups
            git commit -m "n8n工作流备份_$(date +%Y-%m-%d_%H-%M-%S)"
            git push "$PUSH_URL" main
          else
            echo "无备份文件，跳过推送"
          fi
