# N8N工作流自动备份（仅保留自定义名称+整体ZIP打包+保留最近7次备份+每天自动备份）
name: N8N工作流自动备份

on:
  schedule:
    - cron: '0 2 * * *'  # 北京时间每天10点自动备份（UTC时间2点）
  workflow_dispatch:     # 支持手动触发

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 安装基础工具
      - name: 安装依赖工具（jq + curl + zip）
        run: |
          sudo apt update && sudo apt install -y jq curl zip
          mkdir -p ./n8n-backups

      - name: 导出n8n工作流（仅保留自定义名称+纯原始JSON+整体ZIP打包）
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_URL: "https://n8n.lbuding.com"  # 【需修改】你的n8n地址（无末尾/）
        run: |
          # ========== 1. 核心变量定义 ==========
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          JSON_DIR=./n8n-backups/$TIMESTAMP
          ZIP_FILE=./n8n-backups/n8n_backup_$TIMESTAMP.zip
          mkdir -p $JSON_DIR

          # ========== 2. 请求工作流列表 ==========
          WORKFLOW_LIST_RESPONSE=$(curl -s -X GET "$N8N_URL/api/v1/workflows" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json" | jq '.' 2>/dev/null)

          if [ -z "$WORKFLOW_LIST_RESPONSE" ] || ! echo "$WORKFLOW_LIST_RESPONSE" | jq . >/dev/null 2>&1; then
            echo "错误：无法获取n8n工作流列表，请检查地址和密钥"
            exit 1
          fi

          # ========== 3. 解析ID并导出JSON（仅保留自定义名称） ==========
          WORKFLOW_IDS=$(echo "$WORKFLOW_LIST_RESPONSE" | jq -r '.data[].id')
          BACKUP_COUNT=0

          # 定义函数：处理同名文件（自动加序号，避免覆盖）
          get_unique_filename() {
            local base_dir=$1
            local filename=$2
            local extension=${filename##*.}
            local name_without_ext=${filename%.*}
            local unique_filename=$filename
            local counter=1

            while [ -f "$base_dir/$unique_filename" ]; do
              unique_filename="${name_without_ext}_${counter}.${extension}"
              counter=$((counter + 1))
            done

            echo "$unique_filename"
          }

          for ID in $WORKFLOW_IDS; do
            if [ "$ID" = "null" ] || [ -z "$ID" ] || [ "$ID" = "[]" ]; then
              continue
            fi

            # ========== 4. 仅保留N8N自定义名称（去掉ID） ==========
            WORKFLOW_NAME=$(echo "$WORKFLOW_LIST_RESPONSE" | jq -r --arg ID "$ID" '.data[] | select(.id == $ID) | .name')
            # 处理非法字符（保留中文，替换\/:*?"<>|和空格为下划线）
            WORKFLOW_NAME=$(printf "%s" "$WORKFLOW_NAME" | iconv -f UTF-8 -t UTF-8//TRANSLIT | sed -e 's/[\/\\:*?"<>|]/_/g' -e 's/ /_/g' -e 's/^[. ]//g')
            # 兜底名称
            if [ "$WORKFLOW_NAME" = "null" ] || [ -z "$WORKFLOW_NAME" ]; then
              WORKFLOW_NAME="未命名工作流"
            fi

            # 最终文件名：仅自定义名称.json（去掉ID后缀）
            FILE_NAME="${WORKFLOW_NAME}.json"
            # 可选：处理同名文件（注释则关闭）
            FILE_NAME=$(get_unique_filename "$JSON_DIR" "$FILE_NAME")

            echo "===== 开始备份工作流：$FILE_NAME ====="

            # ========== 5. 获取纯原始JSON数据 ==========
            WORKFLOW_DETAIL=$(curl -s -X GET "$N8N_URL/api/v1/workflows/$ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" | jq '.' 2>/dev/null)

            if [ -z "$WORKFLOW_DETAIL" ] || ! echo "$WORKFLOW_DETAIL" | jq . >/dev/null 2>&1; then
              echo "警告：工作流$ID的JSON无效，跳过"
              continue
            fi

            # ========== 6. 保存JSON文件 ==========
            JSON_FILE_PATH="$JSON_DIR/$FILE_NAME"
            echo "$WORKFLOW_DETAIL" | jq . | tee "$JSON_FILE_PATH" >/dev/null

            if [ -s "$JSON_FILE_PATH" ]; then
              BACKUP_COUNT=$((BACKUP_COUNT + 1))
              echo "===== 已备份：$JSON_FILE_PATH ====="
            else
              echo "警告：文件$FILE_NAME生成失败，跳过"
              rm -f "$JSON_FILE_PATH"
            fi
          done

          # ========== 7. 整体打包为ZIP ==========
          if [ $BACKUP_COUNT -gt 0 ]; then
            echo "===== 开始整体打包为ZIP：$ZIP_FILE ====="
            cd ./n8n-backups && zip -r -q -9 "$(basename $ZIP_FILE)" "$TIMESTAMP"
            cd - >/dev/null

            # 可选：删除原始JSON目录（注释则保留）
            rm -rf "$JSON_DIR"

            # 验证ZIP包
            if [ -s "$ZIP_FILE" ]; then
              echo "===== 成功生成ZIP包：$ZIP_FILE（大小：$(du -h $ZIP_FILE | awk '{print $1}')） ====="
              md5sum "$ZIP_FILE" | tee "$ZIP_FILE.md5"
            else
              echo "错误：ZIP包生成失败"
              exit 1
            fi
          else
            echo "警告：未备份任何工作流，跳过打包"
            rm -rf "$JSON_DIR"
            exit 0
          fi

          # ========== 8. 新增：清理旧备份（仅保留最近7次备份） ==========
          echo "===== 开始清理旧备份，仅保留最近7次 ======"
          # 步骤1：进入备份目录
          cd ./n8n-backups || exit 1

          # 步骤2：筛选出备份文件（以n8n_backup_开头，后缀为zip或md5），按修改时间排序（最新的在前）
          # 说明：
          # - ls -tp：按修改时间降序排列，-p添加/标识目录，排除目录
          # - grep -E：筛选zip和md5文件
          # - head -n -14：保留最后14个文件（7个zip + 7个md5），删除前面的旧文件
          # - xargs rm -f：删除选中的旧文件
          ls -tp | grep -E '^n8n_backup_.*\.(zip|md5)$' | grep -v '/$' | head -n -14 | xargs -I {} rm -f {} || echo "暂无需要清理的旧备份"

          # 步骤3：回到原目录
          cd - >/dev/null
          echo "===== 旧备份清理完成 ======"

      # ========== 9. 提交并推送 ==========
      - name: 提交并推送ZIP备份包到GitHub
        env:
          SINGLE_SECRET: ${{ secrets.N8N_API_KEY }}
          GITHUB_REPO_URL: "https://github.com/lengbuding1991/n8n-backups.git"  # 【需修改】你的仓库地址
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # 适配PAT推送
          if echo "$SINGLE_SECRET" | grep -q "|||"; then
            GITHUB_PAT=$(echo "$SINGLE_SECRET" | cut -d'|||' -f2)
            PUSH_URL=$(echo "$GITHUB_REPO_URL" | sed "s/https:\/\//https:\/\/$GITHUB_PAT@/")
          else
            PUSH_URL="$GITHUB_REPO_URL"
          fi

          # 推送文件
          if [ -n "$(ls -A ./n8n-backups 2>/dev/null)" ]; then
            git add ./n8n-backups
            git commit -m "n8n工作流备份_$(date +%Y%m%d_%H%M%S)（仅自定义名称+整体ZIP打包+保留最近7次备份）"
            git push "$PUSH_URL" main
          else
            echo "无备份文件，跳过推送"
          fi
